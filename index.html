<script>
/* ---------- configuration ---------- */
const pages = ["ddc.png","ddc2.png","ddc3.png"];
let index = 0;

/* zoom/pan state */
let zoomSteps = [1, 1.25, 1.5, 1.75, 2];
let zoomIndex = 0;
let zoom = 1;

let panX = 0, panY = 0;
let isPanning = false;
let startPan = {x:0,y:0};
let lastPointer = null;

/* DOM refs */
const track = document.getElementById('track');
const viewport = document.getElementById('viewport');
const pageCounter = document.getElementById('pageCounter');
const imgEls = pages.map((_,i)=>document.getElementById('img-'+i));
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const zoomLabel = document.getElementById('zoomLabel');
const zoomReset = document.getElementById('zoomReset');
const themeToggle = document.getElementById('themeToggle');

/* ---------- THEME ---------- */
function loadTheme(){
  const saved = localStorage.getItem('ddc-theme') || 'dark';
  document.body.setAttribute('data-theme', saved);
  themeToggle.textContent = saved === 'dark' ? '☾' : '☼';
}
function toggleTheme(){
  const now = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', now);
  themeToggle.textContent = now === 'dark' ? '☾' : '☼';
  localStorage.setItem('ddc-theme', now);
}
themeToggle.addEventListener('click', toggleTheme);

/* ---------- PAGE MOVEMENT ---------- */
function updateTrack(animate=true){
  track.style.transition = animate ?
      'transform 420ms cubic-bezier(.22,.9,.26,1)' :
      'none';

  track.style.transform = `translateX(${-index*100}%)`;
  pageCounter.textContent = `${index+1} / ${pages.length}`;

  resetImageTransforms();
}

function goPrev(){
  if(zoom === 1){
    index = (index - 1 + pages.length) % pages.length;  // LOOP FIXED
    updateTrack(true);
  } else {
    resetPanOnly();
  }
}

function goNext(){
  if(zoom === 1){
    index = (index + 1) % pages.length;                 // LOOP FIXED
    updateTrack(true);
  } else {
    resetPanOnly();
  }
}

prevBtn.addEventListener('click', goPrev);
nextBtn.addEventListener('click', goNext);

/* keyboard */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') goPrev();
  if(e.key === 'ArrowRight') goNext();
  if(e.key === '+' || e.key === '=') zoomInBtn.click();
  if(e.key === '-') zoomOutBtn.click();
});

/* ---------- ZOOM ---------- */
function applyZoom(){
  zoom = zoomSteps[zoomIndex];
  zoomLabel.textContent = `${Math.round(zoom * 100)}%`;

  imgEls.forEach(img=>{
    img.style.transition = 'transform 180ms ease';
    img.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
  });

  // show/hide reset button
  if(zoom !== 1 || panX !== 0 || panY !== 0){
    zoomReset.style.opacity = '1';
    zoomReset.style.pointerEvents = 'auto';
  } else {
    zoomReset.style.opacity = '0';
    zoomReset.style.pointerEvents = 'none';
  }
}

zoomInBtn.addEventListener('click', ()=>{
  if(zoomIndex < zoomSteps.length - 1) zoomIndex++;
  applyZoom();
});
zoomOutBtn.addEventListener('click', ()=>{
  if(zoomIndex > 0) zoomIndex--;
  applyZoom();
});
zoomReset.addEventListener('click', ()=>{
  zoomIndex = 0;
  panX = 0; panY = 0;
  applyZoom();
});

function resetPanOnly(){
  panX = 0; panY = 0;
  imgEls.forEach(img => img.style.transform = `translate(0px,0px) scale(${zoom})`);
}

/* ---------- PAN ---------- */
function setPointerCapture(el, evt){
  try{ el.setPointerCapture(evt.pointerId); }catch(e){}
}
function releasePointerCapture(el, evt){
  try{ el.releasePointerCapture(evt.pointerId); }catch(e){}
}

viewport.addEventListener('pointerdown', (ev)=>{
  if(zoom <= 1) return;
  isPanning = true;
  lastPointer = {x: ev.clientX, y: ev.clientY};
  startPan = {x: panX, y: panY};
  setPointerCapture(viewport, ev);
  viewport.style.cursor = 'grabbing';
});

viewport.addEventListener('pointermove', (ev)=>{
  if(!isPanning || zoom <= 1) return;
  const dx = ev.clientX - lastPointer.x;
  const dy = ev.clientY - lastPointer.y;
  panX = startPan.x + dx;
  panY = startPan.y + dy;
  imgEls.forEach(img => img.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`);
});

viewport.addEventListener('pointerup', (ev)=>{
  isPanning = false;
  releasePointerCapture(viewport, ev);
  viewport.style.cursor = 'default';
});

viewport.addEventListener('pointercancel', ()=>{
  isPanning = false;
  viewport.style.cursor = 'default';
});

/* ---------- SWIPE (mobile) ---------- */
let touchStart = null;
viewport.addEventListener('touchstart', (e)=>{
  if(zoom > 1) return;
  const t = e.touches[0];
  touchStart = {x:t.clientX, y:t.clientY};
},{passive:true});

viewport.addEventListener('touchend', (e)=>{
  if(!touchStart) return;
  const t = e.changedTouches[0];
  const dx = t.clientX - touchStart.x;
  const dy = t.clientY - touchStart.y;
  if(Math.abs(dx) > 40){
    if(dx < 0) goNext();
    else goPrev();
  } else if(Math.abs(dy) > 60){
    if(dy < 0) goNext();
    else goPrev();
  }
  touchStart = null;
});

/* ---------- LOAD ---------- */
function resetImageTransforms(){
  if(zoom === 1){
    panX = 0; panY = 0;
    imgEls.forEach(img => img.style.transform = `translate(0px,0px) scale(1)`);
  } else {
    imgEls.forEach(img => img.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadTheme();
  updateTrack(false);
  applyZoom();
});
</script>
